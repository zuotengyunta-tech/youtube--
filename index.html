<script>
  // ★ 必須設定
  const API_KEY = "AIzaSyAxk1YpQSe-qDtFUSUmnjnduanag41Mlyk"; 
  const CHANNEL_ID = "UCIIpMOhV06P88eaJEqn3EJg";

  const container = document.getElementById("videos");

  async function getUploadsPlaylistId() {
    const url =
      `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`;

    const res = await fetch(url);
    const data = await res.json();

    console.log("channels API raw:", data);

    if (!data.items || data.items.length === 0) {
      throw new Error("YouTube APIエラー: チャンネル情報を取得できません（APIキー無効/Quota超過/ID誤り）");
    }

    return data.items[0].contentDetails.relatedPlaylists.uploads;
  }

  async function fetchAllVideos(playlistId, pageToken = "", allItems = []) {
    const url =
      `https://www.googleapis.com/youtube/v3/playlistItems?` +
      `part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}&pageToken=${pageToken}`;

    const res = await fetch(url);
    const data = await res.json();

    if (data.items) {
      allItems = allItems.concat(data.items);
    }

    if (data.nextPageToken) {
      return fetchAllVideos(playlistId, data.nextPageToken, allItems);
    }

    return allItems;
  }

  async function getVideoData(videoId) {
    const url =
      `https://www.googleapis.com/youtube/v3/videos?` +
      `id=${videoId}&part=snippet,contentDetails,statistics&key=${API_KEY}`;

    try {
      const res = await fetch(url);
      if (!res.ok) return null;

      const data = await res.json();
      if (!data.items || data.items.length === 0) return null;

      return data.items[0];
    } catch (e) {
      return null;
    }
  }

  (async () => {
    try {
      const uploadsPlaylistId = await getUploadsPlaylistId();
      const rawItems = await fetchAllVideos(uploadsPlaylistId);

      const videoIds = rawItems
        .map(v => v.snippet?.resourceId?.videoId)
        .filter(id => !!id);

      if (videoIds.length === 0) {
        container.innerText = "動画がありません（非公開のみ？）";
        return;
      }

      const videos = [];
      for (const id of videoIds) {
        const v = await getVideoData(id);
        if (v) videos.push(v);
      }

      if (videos.length === 0) {
        container.innerText = "公開動画がありません。";
        return;
      }

      container.innerHTML = "";
      videos.forEach(v => {
        const title = v.snippet.title;
        const thumbnail = v.snippet.thumbnails.medium.url;
        const videoId = v.id;

        const div = document.createElement("div");
        div.className = "video-item";

        div.innerHTML = `
          <img src="${thumbnail}" alt="${title}" loading="lazy" />
          <p>${title}</p>
        `;

        div.onclick = () => {
          div.innerHTML = `
            <iframe src="https://www.youtube.com/embed/${videoId}?rel=0"
              frameborder="0"
              allowfullscreen
              loading="lazy">
            </iframe>
          `;
        };

        container.appendChild(div);
      });

    } catch (e) {
      console.error(e);
      container.innerText = "APIエラー: " + e.message;
    }
  })();
</script>
