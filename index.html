import requests
import time

API_KEY = "AIzaSyAxk1YpQSe-qDtFUSUmnjnduanag41Mlyk"
CHANNEL_ID = "UCGzxWLH1_1ABKKfSiy2WlAw"  # 右のチャンネル（ジョージ・メンズコーチ）

def get_uploads_playlist_id(channel_id):
    """
    指定チャンネルの「アップロード動画プレイリストID」を取得する
    """
    url = (
        "https://www.googleapis.com/youtube/v3/channels"
        "?part=contentDetails"
        f"&id={channel_id}"
        f"&key={API_KEY}"
    )

    res = requests.get(url).json()

    if "items" not in res or len(res["items"]) == 0:
        raise Exception("チャンネルが見つかりません")

    return res["items"][0]["contentDetails"]["relatedPlaylists"]["uploads"]


def get_all_videos_from_playlist(playlist_id):
    """
    プレイリスト内の動画をすべて取得する（次ページ対応）
    """
    all_videos = []
    next_page = None

    while True:
        url = (
            "https://www.googleapis.com/youtube/v3/playlistItems"
            "?part=snippet"
            f"&playlistId={playlist_id}"
            "&maxResults=50"
            f"&key={API_KEY}"
        )
        if next_page:
            url += f"&pageToken={next_page}"

        res = requests.get(url).json()

        if "items" in res:
            for item in res["items"]:
                snippet = item["snippet"]
                title = snippet["title"]
                video_id = snippet["resourceId"]["videoId"]
                published = snippet["publishedAt"]

                all_videos.append({
                    "title": title,
                    "video_id": video_id,
                    "url": f"https://www.youtube.com/watch?v={video_id}",
                    "publishedAt": published
                })

        # 次ページある？
        next_page = res.get("nextPageToken")
        if not next_page:
            break

        time.sleep(0.1)  # API負荷軽減

    return all_videos


# ------------------------------------------
# 実行
# ------------------------------------------

print("▶ アップロード動画プレイリストIDを取得中...")
playlist_id = get_uploads_playlist_id(CHANNEL_ID)
print("   →", playlist_id)

print("▶ 動画一覧を取得中...")
videos = get_all_videos_from_playlist(playlist_id)

print(f"▶ 取得完了：{len(videos)} 件\n")

for v in videos:
    print(v["publishedAt"], "-", v["title"])
    print(v["url"])
    print()
