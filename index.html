<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>YouTube 動画一覧（埋め込み・全件）</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    h1 {
      margin-bottom: 10px;
    }
    #status {
      margin-bottom: 20px;
      color: #555;
    }
    .video {
      margin-bottom: 40px;
    }
    iframe {
      width: 100%;
      max-width: 560px;
      aspect-ratio: 16 / 9;
      border: none;
      border-radius: 12px;
      background: #000;
    }
    .title {
      margin-top: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>ジョージ・メンズコーチ｜全動画一覧（埋め込み）</h1>
<div id="status">読み込み中…</div>
<div id="videos"></div>

<script>
  // ★ APIキー差し替え済み
  const API_KEY = "AIzaSyAxk1YpQSe-qDtFUSUmnjnduanag41Mlyk";
  const CHANNEL_HANDLE = "coachjoji"; // @は付けない

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    return res.json();
  }

  async function getChannelIdByHandle() {
    const url =
      `https://www.googleapis.com/youtube/v3/channels` +
      `?part=id&forHandle=${CHANNEL_HANDLE}&key=${API_KEY}`;

    const data = await fetchJson(url);

    if (!data.items || data.items.length === 0) {
      throw new Error("チャンネルが見つかりません");
    }
    return data.items[0].id;
  }

  async function getUploadsPlaylistId(channelId) {
    const url =
      `https://www.googleapis.com/youtube/v3/channels` +
      `?part=contentDetails&id=${channelId}&key=${API_KEY}`;

    const data = await fetchJson(url);
    return data.items[0].contentDetails.relatedPlaylists.uploads;
  }

  async function getAllVideosFromPlaylist(playlistId) {
    let videos = [];
    let pageToken = "";

    while (true) {
      const url =
        `https://www.googleapis.com/youtube/v3/playlistItems` +
        `?part=snippet&playlistId=${playlistId}` +
        `&maxResults=50&key=${API_KEY}` +
        (pageToken ? `&pageToken=${pageToken}` : "");

      const data = await fetchJson(url);

      if (data.items) {
        videos.push(...data.items);
      }

      if (!data.nextPageToken) break;
      pageToken = data.nextPageToken;
    }

    return videos;
  }

  async function main() {
    try {
      const channelId = await getChannelIdByHandle();
      const playlistId = await getUploadsPlaylistId(channelId);
      const videos = await getAllVideosFromPlaylist(playlistId);

      videos.sort(
        (a, b) =>
          new Date(b.snippet.publishedAt) -
          new Date(a.snippet.publishedAt)
      );

      document.getElementById("status").innerText =
        `動画数：${videos.length}`;

      const container = document.getElementById("videos");

      videos.forEach(v => {
        if (!v.snippet || !v.snippet.resourceId) return;

        const id = v.snippet.resourceId.videoId;
        const title = v.snippet.title;

        container.insertAdjacentHTML("beforeend", `
          <div class="video">
            <iframe
              src="https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1"
              title="${title.replace(/"/g, "&quot;")}"
              allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen>
            </iframe>
            <div class="title">${title}</div>
          </div>
        `);
      });

    } catch (err) {
      console.error(err);
      document.getElementById("status").innerText =
        "読み込みに失敗しました（APIキー・制限・コンソールを確認）";
    }
  }

  main();
</script>

</body>
</html>
