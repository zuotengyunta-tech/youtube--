<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チャンネル投稿動画一覧（安全版）</title>
  <style>
    .video-item { cursor: pointer; margin-bottom: 20px; }
    .video-item img { max-width: 100%; display: block; }
    iframe { width: 100%; max-width: 560px; height: 315px; }
  </style>
</head>
<body>
  <h1>動画一覧（クリックで再生）</h1>
  <div id="videos">読み込み中...</div>

  <script>
    const API_KEY = "YOUR_API_KEY";  // ← ここをあなたのキーに
    const CHANNEL_ID = "UCmTtK0CuxRzD84yKhrtam4A";  // @coachjoji の channelId

    const container = document.getElementById("videos");

    // チャンネル情報から uploads プレイリストID を取得
    async function getUploadsPlaylistId() {
      const url = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("channels.list HTTP error " + res.status);
      const data = await res.json();
      if (data.error) throw new Error("channels.list API error: " + JSON.stringify(data.error));
      const items = data.items;
      if (!items || items.length === 0) throw new Error("Channel not found");
      return items[0].contentDetails.relatedPlaylists.uploads;
    }

    // プレイリストから動画IDリスト取得（全ページ）
    async function fetchAllVideoIds(playlistId, pageToken = "", ids = []) {
      const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50&key=${API_KEY}` + (pageToken ? `&pageToken=${pageToken}` : "");
      const res = await fetch(url);
      if (!res.ok) throw new Error("playlistItems.list HTTP error " + res.status);
      const data = await res.json();
      if (data.error) throw new Error("playlistItems.list API error: " + JSON.stringify(data.error));

      if (data.items) {
        data.items.forEach(item => {
          const vid = item.snippet?.resourceId?.videoId;
          if (vid) ids.push(vid);
        });
      }

      if (data.nextPageToken) {
        return fetchAllVideoIds(playlistId, data.nextPageToken, ids);
      } else {
        return ids;
      }
    }

    // ページ読み込み時の処理
    (async () => {
      try {
        const uploadsPlaylistId = await getUploadsPlaylistId();
        console.log("uploads playlist id:", uploadsPlaylistId);

        const videoIds = await fetchAllVideoIds(uploadsPlaylistId);
        console.log("videoIds:", videoIds);

        if (!videoIds.length) {
          container.innerText = "動画がありません（公開動画なし／非公開のみ？）";
          return;
        }

        container.innerHTML = "";
        videoIds.forEach(videoId => {
          const thumbUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
          // YouTube のサムネイル URL を直接使う簡易方式

          const div = document.createElement("div");
          div.className = "video-item";
          div.innerHTML = `
            <img src="${thumbUrl}" alt="${videoId}" loading="lazy" />
            <p>${videoId}</p>
          `;
          div.onclick = () => {
            div.innerHTML = `
              <iframe src="https://www.youtube.com/embed/${videoId}?rel=0"
                frameborder="0" allowfullscreen loading="lazy"></iframe>
            `;
          };
          container.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        container.innerText = "エラー: " + e.message;
      }
    })();
  </script>
</body>
</html>
