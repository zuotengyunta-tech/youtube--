<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジョージ・メンズコーチ｜全動画一覧（埋め込み）</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    h1 {
      margin-bottom: 6px;
    }
    #status {
      margin-bottom: 20px;
      color: #555;
    }
    .video {
      margin-bottom: 40px;
      max-width: 560px;
    }

    /* サムネ表示 */
    .thumb {
      position: relative;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      background: #000;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .play {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 64px;
      color: #fff;
      background: rgba(0,0,0,0.3);
    }

    iframe {
      width: 100%;
      aspect-ratio: 16 / 9;
      border: none;
      border-radius: 12px;
      background: #000;
    }

    .title {
      margin-top: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>ジョージ・メンズコーチ｜全動画一覧（埋め込み）</h1>
<div id="status">読み込み中…</div>
<div id="videos"></div>

<script>
  /* ===== 設定 ===== */
  const API_KEY = "AIzaSyAxk1YpQSe-qDtFUSUmnjnduanag41Mlyk"; // 差し替え済み
  const CHANNEL_HANDLE = "coachjoji"; // @は不要

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function getChannelId() {
    const url =
      `https://www.googleapis.com/youtube/v3/channels` +
      `?part=id&forHandle=${CHANNEL_HANDLE}&key=${API_KEY}`;

    const data = await fetchJson(url);
    if (!data.items?.length) throw new Error("チャンネル取得失敗");
    return data.items[0].id;
  }

  async function getUploadsPlaylistId(channelId) {
    const url =
      `https://www.googleapis.com/youtube/v3/channels` +
      `?part=contentDetails&id=${channelId}&key=${API_KEY}`;

    const data = await fetchJson(url);
    return data.items[0].contentDetails.relatedPlaylists.uploads;
  }

  async function getAllVideos(playlistId) {
    let videos = [];
    let pageToken = "";

    while (true) {
      const url =
        `https://www.googleapis.com/youtube/v3/playlistItems` +
        `?part=snippet&playlistId=${playlistId}` +
        `&maxResults=50&key=${API_KEY}` +
        (pageToken ? `&pageToken=${pageToken}` : "");

      const data = await fetchJson(url);
      videos.push(...(data.items || []));

      if (!data.nextPageToken) break;
      pageToken = data.nextPageToken;
    }
    return videos;
  }

  async function main() {
    try {
      const channelId = await getChannelId();
      const playlistId = await getUploadsPlaylistId(channelId);
      const videos = await getAllVideos(playlistId);

      videos.sort(
        (a, b) =>
          new Date(b.snippet.publishedAt) -
          new Date(a.snippet.publishedAt)
      );

      document.getElementById("status").innerText =
        `動画数：${videos.length}`;

      const container = document.getElementById("videos");

      videos.forEach(v => {
        if (!v.snippet?.resourceId) return;

        const id = v.snippet.resourceId.videoId;
        const title = v.snippet.title;
        const thumb = v.snippet.thumbnails.high.url;

        container.insertAdjacentHTML("beforeend", `
          <div class="video">
            <div class="thumb" data-id="${id}">
              <img src="${thumb}" alt="">
              <div class="play">▶</div>
            </div>
            <div class="title">${title}</div>
          </div>
        `);
      });

      /* クリック時に iframe を生成 */
      container.addEventListener("click", e => {
        const box = e.target.closest(".thumb");
        if (!box) return;

        const id = box.dataset.id;
        box.outerHTML = `
          <iframe
            src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1"
            allow="accelerometer; autoplay; encrypted-media; picture-in-picture"
            allowfullscreen>
          </iframe>
        `;
      });

    } catch (err) {
      console.error(err);
      document.getElementById("status").innerText =
        "読み込みに失敗しました（APIキー制限・コンソール確認）";
    }
  }

  main();
</script>

</body>
</html>
